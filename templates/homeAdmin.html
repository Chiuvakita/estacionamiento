{% include "navbarAdmin.html" %}
{% load static %}
{% block content %}

<h1>Gestión de Estacionamiento</h1>

<div class="card">
  <h2>Disponibilidad</h2>
  <p><strong>Espacios disponibles:</strong> {{ disponibles }}</p>
</div>

<!-- Ingreso y salida -->
<div class="card">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    
    <div>
      <h2>Ingresar vehículo</h2>
      <form method="post" action="{% url 'home' %}">
        {% csrf_token %}
        <input type="text" name="patente" placeholder="Patente" required>

        <label for="modo">Modo de asignación</label>
        <select id="modo" name="modo" onchange="toggleSelect()">
          <option value="cualquiera" selected>Automático</option>
          <option value="especifico">Seleccionar espacio</option>
        </select>

        <!-- Menú oculto -->
        <div id="select-estacionamiento" style="display: none; margin-top: 10px;">
          <label for="estacionamiento_id">Espacio</label>
          <select name="estacionamiento_id" id="estacionamiento_id">
            {% for e in estacionamientos %}
              {% if e.estado == 'D' %}
                <option value="{{ e.id }}">#{{ e.id }} - Disponible ({{ e.tipo }})</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <button class="button" style="margin-top: 10px;">Ingresar</button>
      </form>
    </div>

    <div>
      <h2>Salida por patente</h2>
      <form method="post" action="{% url 'marcarSalidaPatente' %}">
        {% csrf_token %}
        <input type="text" name="patente" placeholder="Ej: ABC123">
        <button class="button button-danger">Finalizar</button>
      </form>
    </div>
  </div>
</div>

<div class="card">
  <h2>Espacios ocupados</h2>
  <table>
    <tr><th>Espacio</th><th>Patente</th><th>Hora de ingreso</th><th>Acción</th></tr>
    {% for e in ocupados %}
    <tr>
      <td>#{{ e.id }}</td>
      <td>{{ e.patente }}</td>
      <td>{% if e.fecha_inicio %}{{ e.fecha_inicio|date:"H:i" }}{% else %}-{% endif %}</td>
      <td><a href="{% url 'marcarSalida' e.id %}" class="button button-danger">Marcar salida</a></td>
    </tr>
    {% empty %}
    <tr><td colspan="4">No hay autos estacionados</td></tr>
    {% endfor %}
  </table>
</div>

<script src="{% static 'js/validaciones.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const formIngreso = document.querySelector("form[action$='{% url 'home' %}']");
    if (formIngreso) formIngreso.addEventListener("submit", validarIngresoVehiculo);

    const formSalida = document.querySelector("form[action$='salida_por_patente/']");
    if (formSalida) formSalida.addEventListener("submit", validarSalidaPatente);

    document.querySelectorAll(".button-danger").forEach(btn => {
      btn.addEventListener("click", confirmarAccion);
    });
  });
</script>

{% endblock %}
